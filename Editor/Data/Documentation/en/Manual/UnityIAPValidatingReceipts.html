<!DOCTYPE html><html lang="en" class="no-js">
<head>
<meta content="text/html; charset=UTF-8" http-equiv="Content-Type">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Unity - Manual:  Receipt validation</title>
<meta name="description" content="The Unity Manual helps you learn and use the Unity engine. With the Unity engine you can create 2D and 3D games, apps and experiences.">
<meta name="author" content="Unity Technologies">
<link rel="shortcut icon" href="../StaticFilesManual/images/favicons/favicon.ico">
<link rel="icon" type="image/png" href="../StaticFilesManual/images/favicons/favicon.png">
<link rel="apple-touch-icon-precomposed" sizes="152x152" href="../StaticFilesManual/images/favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="../StaticFilesManual/images/favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon-precomposed" sizes="120x120" href="../StaticFilesManual/images/favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="../StaticFilesManual/images/favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="../StaticFilesManual/images/favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon-precomposed" href="../StaticFilesManual/images/favicons/apple-touch-icon.png">
<meta name="msapplication-TileColor" content="#222c37">
<meta name="msapplication-TileImage" content="../StaticFilesManual/images/favicons/tileicon-144x144.png">
<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-2854981-1']);
  _gaq.push(['_setDomainName', 'unity3d.com']);
  _gaq.push(['_trackPageview']);
  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
  </script><script type="text/javascript" src="../StaticFilesManual/js/jquery.js?ts=1503962755"></script><script type="text/javascript" src="../StaticFilesManual/js/core.js?ts=1503962755"></script><script type="text/javascript" src="docdata/toc.js?ts=1503962755"></script><script type="text/javascript" src="docdata/global_toc.js?ts=1503962755"></script><link href="https://fonts.googleapis.com/css?family=Open+Sans:400,700,400italic" rel="stylesheet" type="text/css">
<link rel="stylesheet" type="text/css" href="../StaticFilesManual/css/core.css?ts=1503962755">
</head>
<body>
<div class="header-wrapper">
<div id="header" class="header"><div class="content">
<div class="spacer"><div class="menu">
<div class="logo"><a href="http://docs.unity3d.com"></a></div>
<div class="search-form"><form action="30_search.html" method="get" class="apisearch">
<input type="text" name="q" placeholder="Search manual..." autosave="Unity Reference" results="5" class="sbox field" id="q"><input type="submit" class="submit">
</form></div>
<ul>
<li><a href="../Manual/index.html" class="selected">Manual</a></li>
<li><a href="../ScriptReference/index.html">Scripting API</a></li>
</ul>
</div></div>
<div class="more">
<div class="filler"></div>
<ul><li><a href="http://unity3d.com/">unity3d.com</a></li></ul>
</div>
</div></div>
<div class="toolbar"><div class="content">
<div class="version-number">Version: <b>5.4 beta</b> (<a href="http://docs.unity3d.com/530/Documentation/Manual">switch to 5.3</a>)</div>
<div class="lang-switcher">
<div class="current toggle" data-target=".lang-list">
<div class="lbl">Language: <span class="b">English</span>
</div>
<div class="arrow"></div>
</div>
<div class="lang-list" style="display:none;"><ul>
<li><a href="/Manual/">English</a></li>
<li><a href="/ja/current/Manual/">日本語</a></li>
<li><a href="/es/current/Manual/">Español</a></li>
<li><a href="/kr/current/Manual/">한국어</a></li>
<li><a href="/ru/current/Manual/">Русский</a></li>
</ul></div>
</div>
</div></div>
</div>
<div id="master-wrapper" class="master-wrapper clear">
<div id="sidebar" class="sidebar"><div class="sidebar-wrap"><div class="content"><div class="sidebar-menu"><div class="toc"><h2>Unity Manual</h2></div></div></div></div></div>
<div id="content-wrap" class="content-wrap"><div class="content-block"><div class="content">
<div class="section">
<div class="breadcrumbs clear"><ul>
<li><a href="UnityManual.html">Unity Manual</a></li>
<li><a href="UnityServices.html">Unity Services</a></li>
<li><a href="UnityIAP.html">Unity IAP</a></li>
<li>Cross Platform Guide</li>
<li> Receipt validation</li>
</ul></div>
<div class="mb20"><div class="nextprev clear">
<div class="icon tt left mr1" data-distance="-40|-30|top">
<span class="prev"><a href="UnityIAPPurchaseReceipts.html"></a></span><div class="tip">Purchase Receipts</div>
</div>
<div class="icon tt right" data-distance="-40|-30|top">
<span class="next"><a href="UnityIAPStoreExtensions.html"></a></span><div class="tip">Store Extensions</div>
</div>
</div></div>
<h1>Receipt validation</h1>
<!--BeginSwitchLink--><!--EndSwitchLink-->
<div class="clear"></div>

<p>You can use receipt validation to make it harder for hackers to access content without paying for it.</p>

<h2>Where to validate</h2>

<p>Where you put validation logic depends on your Application’s requirements, but a general rule is that receipt validation should be performed at the point where content is dispensed.</p>

<p>For example, if you are selling content that is already bundled within your Application, your Application should contain all the logic necessary to decide if a player is entitled to it.</p>

<p>If, however, you are selling content that is delivered by a server, such as downloadable content or multiplayer features, that server is the natural place to apply validation.</p>

<h2>Local validation</h2>

<p>In this scenario we are selling content that already exists on the device; your Application simply makes a decision about whether to unlock it.</p>

<p>Unity IAP provides tools to help you hide secrets, validate and parse receipts on Google Play and Apple stores.</p>

<h3>Obfuscating secrets</h3>

<p>Receipt validation is performed using known encryption keys; your Application’s Google Play public key and/or Apple’s root certificate.</p>

<p>If an attacker can replace these secrets they will be able to defeat your receipt validation checks, so it is important to make difficult for an attacker to easily find and modify these keys.</p>

<p>Unity IAP provides a tool that can help you obfuscate your secret keys within your Application; the Obfuscator window accessible via Window &gt; Unity IAP &gt; IAP Receipt Validation Obfuscator.</p>

<figure>
<img src="../uploads/Main/IAPObfuscator.png" alt="The obfuscator window">
<figcaption>The obfuscator window</figcaption>
</figure>

<p>This window will encode both Apple’s root certificate, which is bundled with Unity IAP, and your Google Play public key, into two different C# files that are added to your project, <strong>GooglePlayTangle</strong> and <strong>AppleTangle</strong>, for use in the next section.</p>

<p>Note that you do not have to provide a Google Play public key if you are only targeting Apple’s stores, or vice versa.</p>

<h3>Validating receipts</h3>

<p>The <strong>CrossPlatformValidator</strong> class can be used for validation across both Google Play and Apple stores.</p>

<p>You must supply this class with either your Google Play public key or Apple’s root certificate, or both if you wish to validate across both platforms.</p>

<p>The checks performed by the CrossPlatformValidator are as follows:</p>

<ol>
<li>Receipt authenticity is checked via signature validation</li>
<li>Receipt Application bundle identifier is compared to your Application’s, with an <strong>InvalidBundleId</strong> exception thrown if they do not match</li>
</ol>

<p>Note that the validator will only validate receipts generated on Google Play and Apple platforms. Receipts generated on any other platform, including the fakes generated in the Editor, will throw an <strong>IAPSecurityException</strong>.</p>

<p>If you attempt to validate a receipt for a platform for which you have not supplied the required secret, a <strong>MissingStoreSecretException</strong> will be thrown.</p>

<pre><code>public PurchaseProcessingResult ProcessPurchase (PurchaseEventArgs e)
{
    bool validPurchase = true; // Presume valid for platforms with no R.V.

    // Unity IAP's validation logic is only included on these platforms.
#if UNITY_ANDROID || UNITY_IOS || UNITY_STANDALONE_OSX
    // Prepare the validator with the secrets we prepared in the Editor
    // obfuscation window.
    var validator = new CrossPlatformValidator(GooglePlayTangle.Data(),
        AppleTangle.Data(), Application.bundleIdentifier);

    try {
        // On Google Play, result will have a single product Id.
        // On Apple stores receipts contain multiple products.
        var result = validator.Validate(e.purchasedProduct.receipt);
        // For informational purposes, we list the receipt(s)
        Debug.Log(&quot;Receipt is valid. Contents:&quot;);
        foreach (IPurchaseReceipt productReceipt in result) {
            Debug.Log(productReceipt.productID);
            Debug.Log(productReceipt.purchaseDate);
            Debug.Log(productReceipt.transactionID);
        }
    } catch (IAPSecurityException) {
        Debug.Log(&quot;Invalid receipt, not unlocking content&quot;);
        validPurchase = false;
    }
#endif

    if (validPurchase) {
        // Unlock the appropriate content here.
    }

    return PurchaseProcessingResult.Complete;
}

</code></pre>

<p>It is important you check not just that the receipt is valid, but what information it contains.</p>

<p>A common attack vector is for hackers to supply receipts from other products or Applications; the receipts are genuine so will pass validation, so you should make decisions based on the product IDs parsed by the CrossPlatformValidator.</p>

<h3>Store specific details</h3>

<p>Different stores have different fields in their purchase receipts. To access store specific fields, <strong>IPurchaseReceipt</strong> can be downcast to two different subtypes, <strong>GooglePlayReceipt</strong> and <strong>AppleInAppPurchaseReceipt</strong>.</p>

<pre><code>var result = validator.Validate(e.purchasedProduct.receipt);
Debug.Log(&quot;Receipt is valid. Contents:&quot;);
foreach (IPurchaseReceipt productReceipt in result) {
    Debug.Log(productReceipt.productID);
    Debug.Log(productReceipt.purchaseDate);
    Debug.Log(productReceipt.transactionID);

    GooglePlayReceipt google = productReceipt as GooglePlayReceipt;
    if (null != google) {
        Debug.Log(google.purchaseState);
        Debug.Log(google.purchaseToken);
    }

    AppleInAppPurchaseReceipt apple = productReceipt as AppleInAppPurchaseReceipt;
    if (null != apple) {
        Debug.Log(apple.originalTransactionIdentifier);
        Debug.Log(apple.cancellationDate);
        Debug.Log(apple.quantity);
    }
}
</code></pre>

<h3>Parsing raw Apple receipts</h3>

<p>The <strong>AppleValidator</strong> class can be used to extract detailed information about an Apple receipt. Note that this class only works with iOS 7+ style App receipts, not Apple’s deprecated transaction receipts.</p>

<pre><code>#if UNITY_ANDROID || UNITY_IOS || UNITY_STANDALONE_OSX
var builder = ConfigurationBuilder.Instance(StandardPurchasingModule.Instance());
// Get a reference to IAppleConfiguration during IAP initialization.
var appleConfig = builder.Configure&lt;IAppleConfiguration&gt;();
var receiptData = System.Convert.FromBase64String(appleConfig.appReceipt);
AppleReceipt receipt = new AppleValidator(AppleTangle.Data()).Validate(receiptData);

Debug.Log(receipt.bundleID);
Debug.Log(receipt.receiptCreationDate);
foreach (AppleInAppPurchaseReceipt productReceipt in receipt.inAppPurchaseReceipts) {
    Debug.Log(productReceipt.transactionIdentifier);
    Debug.Log(productReceipt.productIdentifier);
}
#endif
</code></pre>

<p>The <strong>AppleReceipt</strong> type models Apple’s <a href="https://developer.apple.com/library/ios/releasenotes/General/ValidateAppStoreReceipt/Chapters/ReceiptFields.html#//apple_ref/doc/uid/TP40010573-CH106-SW1">ASN1 receipt format</a>; see their documentation for an explanation of its fields.</p>
<div class="nextprev clear">
<div class="icon tt left mr1" data-distance="-40|-30|top">
<span class="prev"><a href="UnityIAPPurchaseReceipts.html"></a></span><div class="tip">Purchase Receipts</div>
</div>
<div class="icon tt right" data-distance="-40|-30|top">
<span class="next"><a href="UnityIAPStoreExtensions.html"></a></span><div class="tip">Store Extensions</div>
</div>
</div>
</div>
<div class="footer-wrapper"><div class="footer clear">
<div class="copy">
<known_issues><p>Is something described here not working as you expect it to? It might be a <b>Known Issue</b>. Please check with the Issue Tracker at <a href="http://issuetracker.unity3d.com">issuetracker.unity3d.com</a>.</p></known_issues>Copyright © 2016 Unity Technologies. Publication 5.4b-R</div>
<div class="menu">
<a href="http://unity3d.com/learn">Tutorials</a><a href="http://answers.unity3d.com">Community Answers</a><a href="https://support.unity3d.com/hc/en-us">Knowledge Base</a><a href="http://forum.unity3d.com">Forums</a><a href="http://unity3d.com/asset-store">Asset Store</a>
</div>
</div></div>
</div></div></div>
</div>
<noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-MC35ML" height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
<script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
'//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
})(window,document,'script','dataLayer','GTM-MC35ML');</script>
</body>
</html>
